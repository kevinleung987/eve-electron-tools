<app-header [title]="'zKill Listener'">
  <div class="row">
    <h5 class="mx-auto"> Click on <kbd>Start Listening</kbd> to begin listening for new killmails from zKillboard. <kbd>Left-click</kbd>
      to view a mail on zKillboard. <kbd>Right-click</kbd> to delete a mail.</h5>
  </div>
</app-header>
<div class="container">
  <!-- Top Button Row -->
  <div class="row button-row">
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-primary"
              (click)="start()"
              [disabled]="listening">Start Listening</button>
    </div>
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-danger"
              (click)="stop()"
              [disabled]="!listening">Stop Listening</button>
    </div>
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-success"
              (click)="clear()"
              [disabled]="mails.length === 0">Clear Results</button>
    </div>
    <div class="col-2">
      <input type="list-length"
             class="form-control"
             [(ngModel)]="length">
      <small>Length of List</small>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.filters"><b>Enable Filters</b></label>
      </div>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.alerts"><b>Enable Alerts</b></label>
      </div>
    </div>
  </div>
  <!-- Filter toggles -->
  <div class="row button-row"
       [hidden]="!checked.filters">
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-info"
              (click)="filtersHidden = !filtersHidden"
              [disabled]="!checked.ship && !checked.location && !checked.involved">{{filtersHidden ? 'Show Filters' :
        'Hide Filters'}}</button>
    </div>
    <div class="col-2">Num. Filtered: {{numFiltered}}</div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.ship"
                 (change)="activeFilters.ship=null"><b>Filter by Ship</b></label>
      </div>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.location"
                 (change)="activeFilters.location=null"><b>Filter by Location</b></label>
      </div>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.involved"
                 (change)="activeFilters.involved=null"><b>Filter by Involved</b></label>
      </div>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.matchAll"><b>Must match ALL filters</b></label>
      </div>
    </div>
  </div>
  <div *ngIf="!filtersHidden">
    <!-- Ship Filter -->
    <div class="card row"
         *ngIf="checked.ship">
      <h5 class="card-header">Ship</h5>
      <div class="card-body row">
        <div class="col-2">
          <select class="custom-select"
                  [(ngModel)]="filterSettings.ship.whichType">
            <option [value]="whichType.Victim">Victim</option>
            <option [value]="whichType.Attacker">Attacker</option>
          </select>
        </div>
        <div class="col-2">
          <select class="custom-select"
                  [(ngModel)]="filterSettings.ship.filterType">
            <option [value]="shipFilterType.Ship">Ship</option>
            <option [value]="shipFilterType.ShipGroup">Ship Group</option>
          </select>
        </div>
        <div class="col-8">
          <app-search [placeholder]="'Search'"
                      [source]="filterSettings.ship.filterType === shipFilterType.Ship 
                      ? suggest.typeNames : suggest.groupNames"
                      (submit)="onSubmitShip($event)"></app-search>
        </div>
      </div>
    </div>
    <!-- Location Filter -->
    <div class="card row"
         *ngIf="checked.location">
      <h5 class="card-header">Location</h5>
      <div class="card-body row">
        <div class="col-2">
          <select class="custom-select"
                  [(ngModel)]="filterSettings.location.filterType">
            <option [value]="locationFilterType.Region">Region</option>
            <option [value]="locationFilterType.System">System</option>
          </select>
        </div>
        <div class="col-2"></div>
        <div class="col-8">
          <app-search [placeholder]="'Search'"
                      [source]="filterSettings.location.filterType === locationFilterType.Region 
                      ? suggest.regionNames : suggest.systemNames"
                      (submit)="onSubmitLocation($event)"></app-search>
        </div>
      </div>
    </div>
    <!-- Involved Filter -->
    <div class="card row"
         *ngIf="checked.involved">
      <h5 class="card-header">Involved</h5>
      <div class="card-body row">
        <div class="col-2">
          <select class="custom-select"
                  [(ngModel)]="filterSettings.involved.whichType">
            <option [value]="whichType.Victim">Victim</option>
            <option [value]="whichType.Attacker">Attacker</option>
          </select>
        </div>
        <div class="col-2">
          <select class="custom-select"
                  [(ngModel)]="filterSettings.involved.filterType">
            <option [value]="involvedFilterType.Character"
                    selected>Character</option>
            <option [value]="involvedFilterType.Corporation">Corporation</option>
            <option [value]="involvedFilterType.Alliance">Alliance</option>
          </select>
        </div>
        <div class="col-8">
          <app-search [placeholder]="'Search'"
                      [useSuggestions]="false"
                      (submit)="onSubmitInvolved($event)"></app-search>
        </div>
      </div>
    </div>
  </div>
  <!-- Mails -->
  <div class="row"
       *ngFor="let mail of mails; let i = index">
    <div class="card mail-info"
         style="width:100%;"
         (click)="openLink(mail['zkb']['url'])"
         (contextmenu)="mails.pop(i)">
      <div class="card-body row">
        <div class="col-2">
          <div class="row detail-row">
            <b>Time: </b>{{ mail['killmail_time'] | date:'M/d/yy, H:mm':'+000' }} </div>
          <div class="row detail-row">
            <b>System: </b>{{ universe.getSystemName(mail['solar_system_id'])}} <span>[<b [ngStyle]="{'color': universe.getSecurityColor(universe.getSystemSecurity(mail['solar_system_id']))}">{{(universe.getSystemSecurity(mail['solar_system_id'])
                | slice:0:4)}}</b>]</span>
          </div>
          <div class="row detail-row">
            <b>Region: </b>{{ universe.getSystemRegionName(mail['solar_system_id']) }} </div>
          <div class="row detail-row">
            <b>Value: </b>{{ mail['zkb']['totalValue'] | number }} ISK </div>
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['victim']['character_id'] | image:'character'}}">
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['victim']['ship_type_id'] | image:'ship'}}">
        </div>
        <div class="col-3">
          <div class="row">
            <b>Defender: </b>{{ (mail['victim']['character_id'] | eve:'character' | async)?.name }} </div>
          <div class="row">
            <b>Ship: </b>{{ universe.getTypeName(mail['victim']['ship_type_id']) }} </div>
          <div class="row"
               *ngIf="mail['victim']['alliance_id']">
            <img src="{{mail['victim']['alliance_id'] | image:'alliance'}}"
                 class="image-icon">
            <p>{{ (mail['victim']['alliance_id'] | eve:'alliance' | async)?.name }}</p>
          </div>
          <div class="row"
               *ngIf="!mail['victim']['alliance_id']">
            <p>No Alliance</p>
          </div>
          <div class="row">
            <img src="{{mail['victim']['corporation_id'] | image:'corporation'}}"
                 class="image-icon"> {{ (mail['victim']['corporation_id'] | eve:'corporation' | async)?.name }} </div>
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['final_blow']['character_id'] | image:'character'}}">
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['final_blow']['ship_type_id'] | image:'ship'}}">
        </div>
        <div class="col-3">
          <div class="row">
            <b>Attacker: </b>{{ (mail['final_blow']['character_id'] | eve:'character' | async)?.name }} ({{
            mail['zkb']['npc'] ? 'NPC' : mail['attackers'].length }}) </div>
          <div class="row">
            <b>Ship: </b>{{ universe.getTypeName(mail['final_blow']['ship_type_id']) }} </div>
          <div class="row"
               *ngIf="mail['final_blow']['alliance_id']">
            <img class="image-icon"
                 src="{{mail['final_blow']['alliance_id'] | image:'alliance'}}">
            <p>{{ (mail['final_blow']['alliance_id'] | eve:'alliance' | async)?.name }}</p>
          </div>
          <div class="row"
               *ngIf="!mail['final_blow']['alliance_id']">
            <p>No Alliance</p>
          </div>
          <div class="row">
            <img class="image-icon"
                 src="{{mail['final_blow']['corporation_id'] | image:'corporation'}}"> {{
            (mail['final_blow']['corporation_id'] | eve:'corporation' | async)?.name }} </div>
        </div>
      </div>
    </div>
  </div>
</div>