<app-header [title]="'zKill Listener'">
  <div class="row">
    <h5 class="mx-auto"> Click on <kbd>Start Listening</kbd> to begin listening for new killmails from zKillboard. <kbd>Left-click</kbd>
      to view a mail on zKillboard. <kbd>Right-click</kbd> to delete a mail.</h5>
  </div>
</app-header>
<div class="container">
  <!-- Top Button Row -->
  <div class="row button-row">
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-primary"
              (click)="start()"
              [disabled]="listening">Start Listening</button>
    </div>
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-danger"
              (click)="stop()"
              [disabled]="!listening">Stop Listening</button>
    </div>
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-success"
              (click)="clear()"
              [disabled]="mails.length === 0">Clear Results</button>
    </div>
    <div class="col-2">
      <input type="list-length"
             class="form-control"
             [(ngModel)]="length">
      <small>Length of List</small>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.filters"><b>Enable Filters</b></label>
      </div>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.alerts"
                 (click)="debug()"><b>Enable Alerts</b></label>
      </div>
    </div>
  </div>
  <!-- Filter toggles -->
  <div class="row button-row"
       [hidden]="!checked.filters">
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-info"
              (click)="checked.hideSettings = !checked.hideSettings"
              [disabled]="!checked.ship && !checked.location && !checked.involved">{{checked.hideSettings ? 'Show
        Filters' : 'Hide Filters'}}</button>
    </div>
    <div class="col-2">
      <h5>Num. Filtered: {{numFiltered}}</h5>
    </div>
    <div class="col-2">
      <select class="custom-select"
              #addFilterSelect>
        <option [value]="filterType.Ship">Ship</option>
        <option [value]="filterType.Location">Location</option>
        <option [value]="filterType.Involved">Involved</option>
      </select>
    </div>
    <div class="col-2">
      <button type="button"
              class="btn btn-raised btn-info"
              (click)="addFilter(addFilterSelect.value)">Add Filter</button>
    </div>
    <div class="col-2">
      <div class="switch">
        <label>
          <input type="checkbox"
                 [(ngModel)]="checked.matchAll"><b>{{checked.matchAll ? 'Match ALL filters' : 'Match ANY filter'}}</b></label>
      </div>
    </div>
  </div>
  <div *ngIf="checked.filters && !checked.hideSettings">
    <div class="card row"
         *ngFor="let filter of filters; index as i">
      <div class="col-12">
        <div class="card-header row">
          <div class="col-4">
            <h5>{{filter.type}}</h5>
          </div>
        </div>
        <!-- Ship Filter -->
        <div class="card-body row"
             *ngIf="filter.type === filterType.Ship">
          <div class="col-2">
            <select class="custom-select"
                    [(ngModel)]="filter.whichType">
              <option [value]="whichType.Victim">Victim</option>
              <option [value]="whichType.Attacker">Attacker</option>
            </select>
          </div>
          <div class="col-2">
            <select class="custom-select"
                    [(ngModel)]="filter.filterType">
              <option [value]="shipFilterType.Ship">Ship</option>
              <option [value]="shipFilterType.ShipGroup">Ship Group</option>
            </select>
          </div>
          <div class="col-7">
            <app-search #shipFilterSearch
                        [placeholder]="'Search'"
                        [source]="getSource(filter.filterType)"
                        (submit)="onSubmitShip($event, i)"></app-search>
          </div>
          <div class="col-1">
            <button type="button"
                    class="btn btn-raised btn-warning float-right"
                    [disabled]="!filter.active"
                    (click)="shipFilterSearch.clear();filter.active=false">Reset</button>
          </div>
        </div>
        <!-- Location Filter -->
        <div class="card-body row"
             *ngIf="filter.type === filterType.Location">
          <div class="col-2">
            <select class="custom-select"
                    [(ngModel)]="filter.filterType">
              <option [value]="locationFilterType.Region">Region</option>
              <option [value]="locationFilterType.System">System</option>
            </select>
          </div>
          <div class="col-2"></div>
          <div class="col-7">
            <app-search #locationFilterSearch
                        [placeholder]="'Search'"
                        [source]="getSource(filter.filterType)"
                        (submit)="onSubmitLocation($event, i)"></app-search>
          </div>
          <div class="col-1">
            <button type="button"
                    class="btn btn-raised btn-warning float-right"
                    [disabled]="!filter.active"
                    (click)="locationFilterSearch.clear();filter.active=false">Reset</button>
          </div>
        </div>
        <!-- Involved Filter -->
        <div class="card-body row"
             *ngIf="filter.type === filterType.Involved">
          <div class="col-2">
            <select class="custom-select"
                    [(ngModel)]="filter.whichType">
              <option [value]="whichType.Victim">Victim</option>
              <option [value]="whichType.Attacker">Attacker</option>
            </select>
          </div>
          <div class="col-2">
            <select class="custom-select"
                    [(ngModel)]="filter.filterType">
              <option [value]="involvedFilterType.Character">Character</option>
              <option [value]="involvedFilterType.Corporation">Corporation</option>
              <option [value]="involvedFilterType.Alliance">Alliance</option>
            </select>
          </div>
          <div class="col-7">
            <app-search #involvedFilterSearch
                        [placeholder]="'Search'"
                        [useSuggestions]="false"
                        (submit)="onSubmitInvolved($event, i)"></app-search>
          </div>
          <div class="col-1">
            <button type="button"
                    class="btn btn-raised btn-warning float-right"
                    [disabled]="!filter.active"
                    (click)="involvedFilterSearch.clear();filter.active=false">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Mails -->
  <div class="row"
       *ngFor="let mail of mails; let i = index">
    <div class="card mail-info"
         style="width:100%;"
         (click)="openLink(mail['zkb']['url'])"
         (contextmenu)="mails.pop(i)">
      <div class="card-body row">
        <div class="col-2">
          <div class="row detail-row">
            <b>Time: </b>{{ mail['killmail_time'] | date:'M/d/yy, H:mm':'+000' }} </div>
          <div class="row detail-row">
            <b>System: </b>{{ universe.getSystemName(mail['solar_system_id'])}} <span>[<b [ngStyle]="{'color': universe.getSecurityColor(universe.getSystemSecurity(mail['solar_system_id']))}">{{(universe.getSystemSecurity(mail['solar_system_id'])
                | slice:0:4)}}</b>]</span>
          </div>
          <div class="row detail-row">
            <b>Region: </b>{{ universe.getSystemRegionName(mail['solar_system_id']) }} </div>
          <div class="row detail-row">
            <b>Value: </b>{{ mail['zkb']['totalValue'] | number }} ISK </div>
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['victim']['character_id'] | image:'character'}}">
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['victim']['ship_type_id'] | image:'ship'}}">
        </div>
        <div class="col-3">
          <div class="row">
            <b>Defender: </b>{{ (mail['victim']['character_id'] | eve:'character' | async)?.name }} </div>
          <div class="row">
            <b>Ship: </b>{{ universe.getTypeName(mail['victim']['ship_type_id']) }} </div>
          <div class="row"
               *ngIf="mail['victim']['alliance_id']">
            <img src="{{mail['victim']['alliance_id'] | image:'alliance'}}"
                 class="image-icon">
            <p>{{ (mail['victim']['alliance_id'] | eve:'alliance' | async)?.name }}</p>
          </div>
          <div class="row"
               *ngIf="!mail['victim']['alliance_id']">
            <p>No Alliance</p>
          </div>
          <div class="row">
            <img src="{{mail['victim']['corporation_id'] | image:'corporation'}}"
                 class="image-icon"> {{ (mail['victim']['corporation_id'] | eve:'corporation' | async)?.name }} </div>
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['final_blow']['character_id'] | image:'character'}}">
        </div>
        <div class="col-1">
          <img class="image"
               src="{{mail['final_blow']['ship_type_id'] | image:'ship'}}">
        </div>
        <div class="col-3">
          <div class="row">
            <b>Attacker: </b>{{(mail['final_blow']['character_id'] | eve:'character' | async)?.name}} ({{
            mail['zkb']['npc'] ? 'NPC' : mail['attackers'].length }}) </div>
          <div class="row">
            <b>Ship: </b>{{universe.getTypeName(mail['final_blow']['ship_type_id'])}} </div>
          <div class="row"
               *ngIf="mail['final_blow']['alliance_id']">
            <img class="image-icon"
                 src="{{mail['final_blow']['alliance_id'] | image:'alliance'}}">
            <p>{{(mail['final_blow']['alliance_id'] | eve:'alliance' | async)?.name}}</p>
          </div>
          <div class="row"
               *ngIf="!mail['final_blow']['alliance_id']">
            <p>No Alliance</p>
          </div>
          <div class="row">
            <img class="image-icon"
                 src="{{mail['final_blow']['corporation_id'] | image:'corporation'}}">{{
            (mail['final_blow']['corporation_id'] | eve:'corporation' | async)?.name}}</div>
        </div>
      </div>
    </div>
  </div>
</div>